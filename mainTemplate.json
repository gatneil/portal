{
    "$schema":"http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
    "contentVersion":"1.0.0.0",
    "parameters":{
	"location": {
	    "type": "string",
	    "metadata": {
		"description": "location of resources"
	    }
	},
	"baseUrl": {
	    "type": "string",
	    "metadata": {
		"artifactsBaseUrl": "Base URL of the VMSS Template gallery package"
	    },
	    "defaultValue": "https://raw.githubusercontent.com/gatneil/portal/clean"
	},
	"vmssName":{
	    "type":"string",
	    "metadata":{
		"description":"String used as a base for naming resources. Must be 3-61 characters in length."
	    },
	    "maxLength": 61
	},
	"singlePlacementGroup": {
	    "type": "string",
	    "defaultValue": "true",
	    "allowedValues": ["true", "false"]
	},
	"pipLabel": {
	    "type": "string"
	},
	"osType": {
	    "type": "string",
	    "allowedValues": ["Windows", "Linux"]
	}
    },
    "variables":{
	"baseTemplateUri":"[concat(parameters('baseUrl'), '/')]",
	
	"_comment0": "concat lbLogic with parameters('singlePlacementGroup') to get back a template url and parameter set for either deploying the lb or not",
	"lbLogictrue": {
	    "templateUri": "[concat('baseTemplateUri', 'lb.json')]",
	    "parameters": {
		"location": {"value": "[parameters('location')]"},
		"pipName": {"value": "[concat(parameters('vmssName'), 'Pip')]"},
		"pipLabel": {"value": "[parameters('pipLabel')]"},
		"lbName": {"value": "[concat(parameters('vmssName'), 'Lb')]"},
		"osType": {"value": "[parameters('osType')]"}
	    }
	},
	"lbLogicfalse": {
	    "templateUri": "[concat('baseTemplateUri', 'null.json')]",
	    "parameters": {}
	},
	"lbLogic": "variables(concat('lbLogic', parameters('singlePlacementGroup')))"
    },
    
    "resources":
    [
	{
	    "name":"vnetDep",
	    "type":"Microsoft.Resources/deployments",
	    "apiVersion":"2015-11-01",
	    "properties":{
		"mode":"Incremental",
		"templateLink":{
		    "uri":"[concat(variables('baseTemplateUri'), 'vnet.json')]",
		    "contentVersion":"1.0.0.0"
		},
		"parameters": {
		    "location": {"value": "[parameters('location')]"},
		    "vnetName": {"value": "[concat(parameters('vmssName'), 'Vnet')]"}
		}
	    }
	},
	{
	    "name":"lbDep",
	    "type":"Microsoft.Resources/deployments",
	    "apiVersion":"2015-11-01",
	    "properties":{
		"mode":"Incremental",
		"templateLink":{
		    "uri":"[variables('lbLogic').templateUri]",
		    "contentVersion":"1.0.0.0"
		},
		"parameters": "[variables('lbLogic').parameters]"
	    }
	}
    ]
}
